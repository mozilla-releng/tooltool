#! /usr/bin/env nix-shell
#! nix-shell -i zsh -p python37Packages.setuptools python37Packages.virtualenv postgresql zip pkgconfig libffi openssl xz gccStdenv entr ag

set -e

test_var_set() {
  local varname=$1

  if [ -z ${varname} ]; then
    echo "ERROR: ${varname} is not set."
    echo "       Find the following secrets from private repo at passwords/tooltool-localdev."
    exit 1
  fi
}

# -- APPLICATION SETTINGS -----------------------------------------------------
export ENV="localdev"
export PROJECT_NAME="tooltool_api"
export APP_SETTINGS=`realpath ./settings.py`
export HOST="127.0.0.1"
export PORT="8002"
export DATABASE_URL="postgres://tooltooluser:tooltoolpassword@localhost:54320/tooltooldb"
export TASKCLUSTER_ROOT_URL="https://stage.taskcluster.nonprod.cloudops.mozgcp.net"

# find the following secrets from private repo at passwords/tooltool-localdev
test_var_set "S3_REGIONS"
test_var_set "S3_REGIONS_ACCESS_KEY_ID"
test_var_set "S3_REGIONS_SECRET_ACCESS_KEY"
test_var_set "PULSE_USER"
test_var_set "PULSE_PASSWORD"

# -- LOCAL SCRIPT SETTINGS ----------------------------------------------------
PYENV_DIR=./env
PYTHON_VERSION=3.7


# -----------------------------------------------------------------------------

# this makes wheels work with python that is installed via nix
export SOURCE_DATE_EPOCH=315532800;

setup_pyenv() {
  if [ ! -d $PYENV_DIR ]; then
    echo
    echo "--------------------------------------------------------------------"
    echo " 1. Create python virtualenv environment for python${PYTHON_VERSION}"
    echo "--------------------------------------------------------------------"
    echo
    virtualenv env -p python${PYTHON_VERSION};

    echo
    echo "--------------------------------------------------------------------"
    echo " 2. Make sure we always use latest version of pip"
    echo "--------------------------------------------------------------------"
    echo
    $PYENV_DIR/bin/pip install --upgrade pip;

    echo
    echo "--------------------------------------------------------------------"
    echo " 3. Install tox as a test runner"
    echo "--------------------------------------------------------------------"
    echo
    $PYENV_DIR/bin/pip install tox;

    export PATH=$PYENV_DIR/bin:$PATH
    export VIRTUAL_ENV=`realpath $PYENV_DIR`
  fi
}

display_help() {
    echo "USAGE: ./dev [option...] {run|test}"
    echo
    echo "   run    run $PROJECT_NAME in localdev mode"
    echo "   test   run ${PROJECT_NAME}'s tests and linting"
    echo
}

case "$1" in;
  "run")
    setup_pyenv
    if [ ! -e $PYENV_DIR/bin/gunicorn ]; then
      # install runtime and dev(time) dependencies
      $PYENV_DIR/bin/pip install -r ./requirements/base.txt
      # install project itself
      $PYENV_DIR/bin/pip install -e ./
    fi
    exec ./docker.d/run.sh
    exit 0
    ;;
  "test")
    setup_pyenv
    ag -l | entr -s "${PYENV_DIR}/bin/tox -e py${PYTHON_VERSION:0:1}${PYTHON_VERSION:2:3}"
    exit 0
    ;;
  *)
    display_help
    exit 1
    ;;
esac
